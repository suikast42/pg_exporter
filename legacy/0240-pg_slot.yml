#==============================================================#
# 0240 pg_slot
#==============================================================#
pg_slot_94:
  name: pg_slot
  desc: PostgreSQL replication slot metrics 9.4 - 9.6
  query: |-
    SELECT slot_name, slot_type, plugin, database AS datname, datoid, active_pid,
      active, FALSE AS temporary,
      xmin::TEXT::BIGINT AS xmin, catalog_xmin::TEXT::BIGINT AS catalog_xmin,
      restart_lsn, confirm_lsn, current_lsn - restart_lsn AS retained_bytes
    FROM (
      SELECT slot_name, slot_type, plugin, database, datoid, active_pid, active, xmin, catalog_xmin,
        (('x' || lpad(split_part(restart_lsn::text, '/', 1), 8, '0'))::bit(32)::bigint * 4294967296
         + ('x' || lpad(split_part(restart_lsn::text, '/', 2), 8, '0'))::bit(32)::bigint) AS restart_lsn,
        (('x' || lpad(split_part(confirmed_flush_lsn::text, '/', 1), 8, '0'))::bit(32)::bigint * 4294967296
         + ('x' || lpad(split_part(confirmed_flush_lsn::text, '/', 2), 8, '0'))::bit(32)::bigint) AS confirm_lsn,
        (('x' || lpad(split_part(current.loc::text, '/', 1), 8, '0'))::bit(32)::bigint * 4294967296
         + ('x' || lpad(split_part(current.loc::text, '/', 2), 8, '0'))::bit(32)::bigint) AS current_lsn
      FROM pg_replication_slots,
           (SELECT CASE WHEN pg_is_in_recovery() THEN pg_last_xlog_replay_location() ELSE pg_current_xlog_location() END AS loc) current
    ) d;

  ttl: 10
  min_version: 90400
  max_version: 100000
  tags: [ cluster, primary ]
  metrics:
    - slot_name:      { usage: LABEL    ,description: A unique, cluster-wide identifier for the replication slot }
    - slot_type:      { usage: LABEL    ,description: The slot type, physical or logical }
    - plugin:         { usage: LABEL    ,description: The base name of the shared object containing the output plugin this logical slot is using, or null for physical slots. }
    - datname:        { usage: LABEL    ,description: The name of the database this slot is associated with, logical slots only, null for physical slot }
    - datoid:         { usage: GAUGE    ,description: The OID of the database this slot is associated with, logical slots only, null for physical slot }
    - active_pid:     { usage: GAUGE    ,description: The process ID of the session streaming data for this slot. NULL if inactive. }
    - active:         { usage: GAUGE    ,description: True(1) if this slot is currently actively being used }
    - temporary:      { usage: GAUGE    ,description: True(1) if this is a temporary replication slot (N/A on 9.x, always 0) }
    - xmin:           { usage: COUNTER  ,description: The oldest transaction that this slot needs the database to retain. }
    - catalog_xmin:   { usage: COUNTER  ,description: The oldest transaction affecting the system catalogs that this slot needs the database to retain. }
    - restart_lsn:    { usage: COUNTER  ,description: The address (LSN) of oldest WAL which still might be required by the consumer of this slot }
    - confirm_lsn:    { usage: COUNTER  ,description: The address (LSN) up to which the logical slot's consumer has confirmed receiving data. }
    - retained_bytes: { usage: GAUGE    ,description: Size of bytes that retained for this slot }

