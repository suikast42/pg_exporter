#==============================================================#
# 0700 pg_table
#==============================================================#
pg_table_94:
  name: pg_table
  desc: PostgreSQL table metrics 9.4-9.6
  query: |-
    SELECT CURRENT_CATALOG AS datname, nsp.nspname || '.' || c.relname AS relname, c.oid AS relid, ascii(c.relkind) AS kind,
       c.relpages AS pages, c.reltuples AS tuples, c.relfrozenxid AS frozenxid, age(c.relfrozenxid) AS age, c.relnatts AS ncols,
       psut.seq_scan,psut.seq_tup_read,psut.idx_scan,psut.idx_tup_fetch,psut.seq_scan + psut.idx_scan AS tbl_scan, psut.seq_tup_read + psut.idx_tup_fetch AS tup_read,
       psut.n_tup_ins,psut.n_tup_upd,psut.n_tup_del,(psut.n_tup_ins + psut.n_tup_upd + psut.n_tup_del) AS n_tup_mod,psut.n_tup_hot_upd,psut.n_live_tup,psut.n_dead_tup,
       psut.n_mod_since_analyze,psut.last_vacuum,psut.last_autovacuum,psut.last_analyze,psut.last_autoanalyze,
       psut.vacuum_count,psut.autovacuum_count,psut.analyze_count,psut.autoanalyze_count,
       psio.heap_blks_read,psio.heap_blks_hit,psio.idx_blks_read,psio.idx_blks_hit,psio.toast_blks_read,psio.toast_blks_hit,psio.tidx_blks_read,psio.tidx_blks_hit
    FROM pg_class c JOIN pg_namespace nsp ON c.relnamespace = nsp.oid
        LEFT JOIN pg_stat_user_tables psut ON psut.relid = c.oid LEFT JOIN pg_statio_user_tables psio ON psio.relid = c.oid
    WHERE nsp.nspname !~ '^pg_' AND nsp.nspname !~ '^_' AND nsp.nspname !~ '^timescaledb' AND nsp.nspname !~ '^citus' AND nsp.nspname !~ '^columnar'
        AND nsp.nspname NOT IN ('pg_catalog','information_schema','pg_toast','repack','monitor') AND c.relkind = ANY (ARRAY ['r','m','t','p'])
    ORDER BY c.relpages DESC LIMIT 256;

  ttl: 10
  timeout: 2
  min_version: 90400
  metrics:
    - datname:             { usage: LABEL                 ,description: Database name of this table }
    - relname:             { usage: LABEL                 ,description: Relation name of this table }
    - relid:               { usage: GAUGE                 ,description: Relation oid of this table }
    - kind:                { usage: GAUGE                 ,description: Relation kind r/table/114,m/mview/109,t/toast/116 }
    - pages:               { usage: GAUGE                 ,description: Size of the on-disk representation of this table in pages }
    - tuples:              { usage: GAUGE                 ,description: Estimated number of rows in this table }
    - frozenxid:           { usage: GAUGE                 ,description: All txid before this have been frozen on this table }
    - age:                 { usage: GAUGE                 ,description: Age of this table in vacuum cycles }
    - ncols:               { usage: GAUGE                 ,description: Number of columns in the table }
    - seq_scan:            { usage: COUNTER  ,default: 0  ,description: Number of sequential scans initiated on this table }
    - seq_tup_read:        { usage: COUNTER  ,default: 0  ,description: Number of live rows fetched by sequential scans }
    - idx_scan:            { usage: COUNTER  ,default: 0  ,description: Number of index scans initiated on this table }
    - idx_tup_fetch:       { usage: COUNTER  ,default: 0  ,description: Number of live rows fetched by index scans }
    - tbl_scan:            { usage: COUNTER  ,default: 0  ,description: Number of scans initiated on this table }
    - tup_read:            { usage: COUNTER  ,default: 0  ,description: Number of live rows fetched by scans }
    - n_tup_ins:           { usage: COUNTER  ,default: 0  ,description: Number of rows inserted }
    - n_tup_upd:           { usage: COUNTER  ,default: 0  ,description: Number of rows updated (includes HOT updated rows) }
    - n_tup_del:           { usage: COUNTER  ,default: 0  ,description: Number of rows deleted }
    - n_tup_mod:           { usage: COUNTER  ,default: 0  ,description: Number of rows modified (insert + update + delete) }
    - n_tup_hot_upd:       { usage: COUNTER  ,default: 0  ,description: Number of rows HOT updated (i.e with no separate index update required) }
    - n_live_tup:          { usage: GAUGE                 ,description: Estimated number of live rows }
    - n_dead_tup:          { usage: GAUGE                 ,description: Estimated number of dead rows }
    - n_mod_since_analyze: { usage: GAUGE                 ,description: Estimated number of rows modified since this table was last analyzed }
    - last_vacuum:         { usage: DISCARD               ,description: Last time at which this table was manually vacuumed (not counting VACUUM FULL) }
    - last_autovacuum:     { usage: DISCARD               ,description: Last time at which this table was vacuumed by the autovacuum daemon }
    - last_analyze:        { usage: DISCARD               ,description: Last time at which this table was manually analyzed }
    - last_autoanalyze:    { usage: DISCARD               ,description: Last time at which this table was analyzed by the autovacuum daemon }
    - vacuum_count:        { usage: COUNTER  ,default: 0  ,description: Number of times this table has been manually vacuumed (not counting VACUUM FULL) }
    - autovacuum_count:    { usage: COUNTER  ,default: 0  ,description: Number of times this table has been vacuumed by the autovacuum daemon }
    - analyze_count:       { usage: COUNTER  ,default: 0  ,description: Number of times this table has been manually analyzed }
    - autoanalyze_count:   { usage: COUNTER  ,default: 0  ,description: Number of times this table has been analyzed by the autovacuum daemon }
    - heap_blks_read:      { usage: COUNTER  ,default: 0  ,description: Number of disk blocks read from this table }
    - heap_blks_hit:       { usage: COUNTER  ,default: 0  ,description: Number of buffer hits in this table }
    - idx_blks_read:       { usage: COUNTER  ,default: 0  ,description: Number of disk blocks read from all indexes on this table }
    - idx_blks_hit:        { usage: COUNTER  ,default: 0  ,description: Number of buffer hits in all indexes on this table }
    - toast_blks_read:     { usage: DISCARD  ,default: 0  ,description: Number of disk blocks read from this table's TOAST table (if any) }
    - toast_blks_hit:      { usage: DISCARD  ,default: 0  ,description: Number of buffer hits in this table's TOAST table (if any) }
    - tidx_blks_read:      { usage: DISCARD  ,default: 0  ,description: Number of disk blocks read from this table's TOAST table indexes (if any) }
    - tidx_blks_hit:       { usage: DISCARD  ,default: 0  ,description: Number of buffer hits in this table's TOAST table indexes (if any) }

pg_table_90:
  name: pg_table
  desc: PostgreSQL table metrics 9.0-9.3 (no n_mod_since_analyze)
  query: |-
    SELECT CURRENT_CATALOG AS datname, nsp.nspname || '.' || c.relname AS relname, c.oid AS relid, ascii(c.relkind) AS kind,
       c.relpages AS pages, c.reltuples AS tuples, c.relfrozenxid AS frozenxid, age(c.relfrozenxid) AS age, c.relnatts AS ncols,
       psut.seq_scan,psut.seq_tup_read,psut.idx_scan,psut.idx_tup_fetch,psut.seq_scan + psut.idx_scan AS tbl_scan, psut.seq_tup_read + psut.idx_tup_fetch AS tup_read,
       psut.n_tup_ins,psut.n_tup_upd,psut.n_tup_del,(psut.n_tup_ins + psut.n_tup_upd + psut.n_tup_del) AS n_tup_mod,psut.n_tup_hot_upd,psut.n_live_tup,psut.n_dead_tup,
       NULL::BIGINT AS n_mod_since_analyze, psut.last_vacuum,psut.last_autovacuum,psut.last_analyze,psut.last_autoanalyze,
       psut.vacuum_count,psut.autovacuum_count,psut.analyze_count,psut.autoanalyze_count,
       psio.heap_blks_read,psio.heap_blks_hit,psio.idx_blks_read,psio.idx_blks_hit,psio.toast_blks_read,psio.toast_blks_hit,psio.tidx_blks_read,psio.tidx_blks_hit
    FROM pg_class c JOIN pg_namespace nsp ON c.relnamespace = nsp.oid
        LEFT JOIN pg_stat_user_tables psut ON psut.relid = c.oid LEFT JOIN pg_statio_user_tables psio ON psio.relid = c.oid
    WHERE nsp.nspname !~ '^pg_' AND nsp.nspname !~ '^_' AND nsp.nspname !~ '^timescaledb' AND nsp.nspname !~ '^citus' AND nsp.nspname !~ '^columnar'
        AND nsp.nspname NOT IN ('pg_catalog','information_schema','pg_toast','repack','monitor') AND c.relkind = ANY (ARRAY ['r','m','t','p'])
    ORDER BY c.relpages DESC LIMIT 256;

  ttl: 10
  timeout: 2
  min_version: 90000
  max_version: 90400
  metrics:
    - datname:             { usage: LABEL                 ,description: Database name of this table }
    - relname:             { usage: LABEL                 ,description: Relation name of this table }
    - relid:               { usage: GAUGE                 ,description: Relation oid of this table }
    - kind:                { usage: GAUGE                 ,description: Relation kind r/table/114,t/toast/116 }
    - pages:               { usage: GAUGE                 ,description: Size of the on-disk representation of this table in pages }
    - tuples:              { usage: GAUGE                 ,description: Estimated number of rows in this table }
    - frozenxid:           { usage: GAUGE                 ,description: All txid before this have been frozen on this table }
    - age:                 { usage: GAUGE                 ,description: Age of this table in vacuum cycles }
    - ncols:               { usage: GAUGE                 ,description: Number of columns in the table }
    - seq_scan:            { usage: COUNTER  ,default: 0  ,description: Number of sequential scans initiated on this table }
    - seq_tup_read:        { usage: COUNTER  ,default: 0  ,description: Number of live rows fetched by sequential scans }
    - idx_scan:            { usage: COUNTER  ,default: 0  ,description: Number of index scans initiated on this table }
    - idx_tup_fetch:       { usage: COUNTER  ,default: 0  ,description: Number of live rows fetched by index scans }
    - tbl_scan:            { usage: COUNTER  ,default: 0  ,description: Number of scans initiated on this table }
    - tup_read:            { usage: COUNTER  ,default: 0  ,description: Number of live rows fetched by scans }
    - n_tup_ins:           { usage: COUNTER  ,default: 0  ,description: Number of rows inserted }
    - n_tup_upd:           { usage: COUNTER  ,default: 0  ,description: Number of rows updated (includes HOT updated rows) }
    - n_tup_del:           { usage: COUNTER  ,default: 0  ,description: Number of rows deleted }
    - n_tup_mod:           { usage: COUNTER  ,default: 0  ,description: Number of rows modified (insert + update + delete) }
    - n_tup_hot_upd:       { usage: COUNTER  ,default: 0  ,description: Number of rows HOT updated (i.e with no separate index update required) }
    - n_live_tup:          { usage: GAUGE                 ,description: Estimated number of live rows }
    - n_dead_tup:          { usage: GAUGE                 ,description: Estimated number of dead rows }
    - n_mod_since_analyze: { usage: GAUGE                 ,description: Estimated number of rows modified since this table was last analyzed (N/A on 9.0-9.3, NULL) }
    - last_vacuum:         { usage: DISCARD               ,description: Last time at which this table was manually vacuumed (not counting VACUUM FULL) }
    - last_autovacuum:     { usage: DISCARD               ,description: Last time at which this table was vacuumed by the autovacuum daemon }
    - last_analyze:        { usage: DISCARD               ,description: Last time at which this table was manually analyzed }
    - last_autoanalyze:    { usage: DISCARD               ,description: Last time at which this table was analyzed by the autovacuum daemon }
    - vacuum_count:        { usage: COUNTER  ,default: 0  ,description: Number of times this table has been manually vacuumed (not counting VACUUM FULL) }
    - autovacuum_count:    { usage: COUNTER  ,default: 0  ,description: Number of times this table has been vacuumed by the autovacuum daemon }
    - analyze_count:       { usage: COUNTER  ,default: 0  ,description: Number of times this table has been manually analyzed }
    - autoanalyze_count:   { usage: COUNTER  ,default: 0  ,description: Number of times this table has been analyzed by the autovacuum daemon }
    - heap_blks_read:      { usage: COUNTER  ,default: 0  ,description: Number of disk blocks read from this table }
    - heap_blks_hit:       { usage: COUNTER  ,default: 0  ,description: Number of buffer hits in this table }
    - idx_blks_read:       { usage: COUNTER  ,default: 0  ,description: Number of disk blocks read from all indexes on this table }
    - idx_blks_hit:        { usage: COUNTER  ,default: 0  ,description: Number of buffer hits in all indexes on this table }
    - toast_blks_read:     { usage: DISCARD  ,default: 0  ,description: Number of disk blocks read from this table's TOAST table (if any) }
    - toast_blks_hit:      { usage: DISCARD  ,default: 0  ,description: Number of buffer hits in this table's TOAST table (if any) }
    - tidx_blks_read:      { usage: DISCARD  ,default: 0  ,description: Number of disk blocks read from this table's TOAST table indexes (if any) }
    - tidx_blks_hit:       { usage: DISCARD  ,default: 0  ,description: Number of buffer hits in this table's TOAST table indexes (if any) }
